<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture - Owl Always Love You</title>
    <style>
        /* CSS เดิมทั้งหมดของคุณ */
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Pacifico&display=swap');
        :root { --primary-pink: #ff85a2; --dark-pink: #f72585; --soft-pink: #ffe5ec; --glass: rgba(255, 255, 255, 0.8); }
        body { font-family: 'Kanit', sans-serif; background: linear-gradient(135deg, #fce4ec 0%, #ffebee 100%); margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        .container { position: relative; z-index: 10; display: grid; grid-template-rows: auto 1fr; width: 95%; height: 90vh; max-width: 1400px; padding: 20px; background: var(--glass); backdrop-filter: blur(20px); border-radius: 40px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 20px 40px rgba(0,0,0,0.05); box-sizing: border-box; }
        .workspace { display: grid; grid-template-columns: 280px 1fr 280px; gap: 20px; align-items: center; height: 100%; overflow: hidden; }
        .camera-frame { width: 100%; max-width: 640px; aspect-ratio: 4/3; background: #000; border-radius: 30px; overflow: hidden; border: 10px solid white; box-shadow: 0 25px 50px rgba(247, 37, 133, 0.15); position: relative; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .shutter-btn { width: 85px; height: 85px; background: white; border: none; border-radius: 50%; cursor: pointer; margin-top: 25px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); transition: 0.2s; }
        .shutter-btn::after { content: ''; width: 70px; height: 70px; background: var(--dark-pink); border-radius: 50%; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--dark-pink); font-weight: 600; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-family: 'Pacifico'; font-size: 3rem; margin-bottom: 20px;">Merging...</div>
        <div>กำลังครอปรูปแนวนอนให้เต็มกรอบแนวตั้ง...</div>
    </div>

    <div class="container">
        <div class="workspace">
            <div class="left-panel">
                <div id="layoutSim"></div>
                <div id="status">READY</div>
            </div>
            <div class="center-panel">
                <div class="camera-frame">
                    <video id="video" autoplay playsinline></video>
                    <div id="countdown" class="countdown-overlay"></div>
                    <div id="flash" class="flash-effect"></div>
                </div>
                <button id="shutterBtn" class="shutter-btn" onclick="startAutoSequence()"></button>
            </div>
            <div class="right-panel">
                <div id="filterGrid" class="filter-list"></div>
            </div>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const shutterBtn = document.getElementById('shutterBtn');
    const urlParams = new URLSearchParams(window.location.search);
    const layoutType = urlParams.get('layout') || 'strip3';
    let shots = [];
    const maxShots = layoutType === 'grid2x2' ? 4 : (layoutType === 'polaroid' ? 1 : (layoutType === 'strip4' ? 4 : 3));

    navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } }).then(s => video.srcObject = s);

    async function startAutoSequence() {
        shutterBtn.disabled = true;
        shots = [];
        for (let i = 0; i < maxShots; i++) {
            await new Promise(r => setTimeout(r, 2000)); // จำลองดีเลย์
            capture(i);
        }
        processAndGoToCustomize();
    }

    function capture(index) {
        const c = document.getElementById('canvas');
        c.width = video.videoWidth; c.height = video.videoHeight;
        const ctx = c.getContext('2d');
        ctx.drawImage(video, 0, 0);
        shots.push(c.toDataURL('image/jpeg', 0.95));
    }

    // ฟังก์ชันสำคัญ: ครอปรูปแนวนอนให้เต็มพื้นที่แนวตั้ง (Object-fit: cover)
    function drawCoverImage(ctx, img, x, y, targetW, targetH) {
        const imgRatio = img.width / img.height;
        const targetRatio = targetW / targetH;
        let sw, sh, sx, sy;
        if (imgRatio > targetRatio) { 
            sh = img.height; sw = img.height * targetRatio; 
            sx = (img.width - sw) / 2; sy = 0; 
        } else { 
            sw = img.width; sh = img.width / targetRatio; 
            sx = 0; sy = (img.height - sh) / 2; 
        }
        ctx.drawImage(img, sx, sy, sw, sh, x, y, targetW, targetH);
    }

    async function processAndGoToCustomize() {
        document.getElementById('loading-overlay').style.display = 'flex';
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');

        // --- 1. ตั้งค่าพื้นหลังกระดาษ (Canvas Size) ---
        if (layoutType === 'grid2x2') { c.width = 1200; c.height = 1800; } 
        else if (layoutType === 'polaroid') { c.width = 900; c.height = 1100; }
        else { c.width = 600; c.height = 1800; }

        const imgObjs = await Promise.all(shots.map(src => new Promise(resolve => {
            const i = new Image(); i.onload = () => resolve(i); i.src = src;
        })));

        // --- 2. ตั้งค่าปรับขนาดรูปใน Grid 2x2 ได้ง่ายๆ ตรงนี้ครับ ---
        if (layoutType === 'grid2x2') {
            const bleed = 22; // เผื่อขอบไว้ให้กรอบทับ
            const shotW = 440; // ปรับความกว้างรูปที่นี่
            const shotH = 590; // ปรับความสูงรูปที่นี่ (แนวตั้ง)
            
            // พิกัด X, Y ของแต่ละรูป
            const pos = [
                [155, 195], // รูป 1
                [600, 195], // รูป 2
                [155, 790], // รูป 3
                [600, 790]  // รูป 4
            ];

            imgObjs.forEach((img, i) => {
                drawCoverImage(ctx, img, 
                    pos[i][0] - (bleed/2), 
                    pos[i][1] - (bleed/2), 
                    shotW + bleed, 
                    shotH + bleed
                );
            });
        } 
        // เลย์เอาต์อื่นๆ
        else if (layoutType === 'strip3') {
            imgObjs.forEach((img, i) => drawCoverImage(ctx, img, 40, 250 + (i * 429), 520, 390));
        }

        localStorage.setItem('raw_photo', c.toDataURL('image/png'));
        localStorage.setItem('layout_type', layoutType);
        window.location.href = 'customize.html';
    }
</script>
</body>
</html>
